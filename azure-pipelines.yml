# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
- master

jobs:
- job: linting
  displayName: Linting
  pool:
    vmImage: ubuntu-latest
  steps:
    - bash: echo "##vso[task.prependpath]$CONDA/bin"
      displayName: Add conda to PATH
    - bash: sudo chown -R $USER $CONDA
      displayName: Take ownership of conda installation
    - bash: conda create --name flake8_env --yes flake8
      displayName: Install flake8
    - bash: |
        if [[ $BUILD_SOURCEVERSIONMESSAGE =~ \[lint\ skip\] ]]; then
          # skip linting
          echo "Skipping linting"
          exit 0
        else
          source activate flake8_env
          ./continuous_integration/azure/flake8_diff.sh
        fi
      displayName: Run linting

- job: testing
  displayName: Testing
  strategy:
    matrix:
      linux_pypy3:
        imageName: 'ubuntu-latest'
        PYTHON_VERSION: "pypy3"
        LOKY_MAX_CPU_COUNT: "2"

      linux_py38:
        imageName: 'ubuntu-latest'
        PYTHON_VERSION: "3.8"
        NUMPY_VERSION: "1.18"
        COVERAGE: "true"
      linux_py37_sklearn_tests:
        imageName: 'ubuntu-latest'
        PYTHON_VERSION: "3.7"
        NUMPY_VERSION: "1.16"
        SKIP_TESTS: "true"
        SKLEARN_TESTS: "true"
      linux_py37_distributed:
        imageName: 'ubuntu-latest'
        PYTHON_VERSION: "3.7"
        NUMPY_VERSION: "1.15"
        COVERAGE: "true"
        DISTRIBUTED_VERSION: "1.23"
      linux_py36_cython:
        imageName: 'ubuntu-latest'
        PYTHON_VERSION: "3.6"
        NUMPY_VERSION: "1.14"
        COVERAGE: "true"
        CYTHON: "true"
      linux_py36_no_multiprocessing:
        imageName: 'ubuntu-latest'
        PYTHON_VERSION: "3.6"
        NUMPY_VERSION: "1.14"
        JOBLIB_MULTIPROCESSING: "0"
        COVERAGE: "true"
      linux_py35_no_numpy:
        imageName: 'ubuntu-latest'
        PYTHON_VERSION: "3.5"
      linux_py27_no_lza:
        imageName: 'ubuntu-latest'
        NO_LZ4: "true"
        PYTHON_VERSION: "2.7"
        NUMPY_VERSION: "1.16"
        COVERAGE: "true"

      windows_py38:
        imageName: "vs2017-win2016"
        PYTHON_VERSION: "3.8"
        NUMPY_VERSION: "1.18"
        COVERAGE: "true"
      windows_py35_no_numpy:
        imageName: "vs2017-win2016"
        PYTHON_VERSION: "3.5"
      windows-py27:
        imageName: "vs2017-win2016"
        PYTHON_VERSION: "2.7"
        NUMPY_VERSION: "1.16"
        COVERAGE: "true"

      macos_py38:
        imageName: "macos-10.13"
        PYTHON_VERSION: "3.8"
        NUMPY_VERSION: "1.18"
      macos_py35_no_numpy:
        imageName: "macos-10.13"
        PYTHON_VERSION: "3.5"
      macos_py27:
        imageName: "macos-10.13"
        PYTHON_VERSION: "2.7"
        NUMPY_VERSION: "1.16"
        COVERAGE: "true"

  pool:
    vmImage: $(imageName)

  steps:

  - bash: echo "##vso[task.prependpath]$CONDA/bin"
    displayName: Add conda to PATH

  - bash: sudo chown -R $USER $CONDA
    displayName: Take ownership of conda installation

  - bash: |
      source continuous_integration/azure/install.sh
    displayName: 'Install joblib and its dependencies'

  - bash: |
      source continuous_integration/azure/run_tests.sh
    displayName: 'Run the tests'
